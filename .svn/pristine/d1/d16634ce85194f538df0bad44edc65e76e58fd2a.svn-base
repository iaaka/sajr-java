package ann;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.PrintStream;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashSet;

import htsjdk.samtools.SamInputResource;
import htsjdk.samtools.SamReader;
import htsjdk.samtools.SAMRecord;
import htsjdk.samtools.SAMRecordIterator;
import htsjdk.samtools.SamReaderFactory;
import htsjdk.samtools.reference.IndexedFastaSequenceFile;

import util.Log;
import util.Settings;
import util.bio.Annotation;
import util.bio.GFFException;
import util.bio.Gene;

public class Annotator {
	GFFPrinter gffp;
	SamReader in;
	SAMRecordIterator iter;
	SAMRecord cur;
	String chr_id;
	ChrCoverage chrCov;
	IndexedFastaSequenceFile fasta;
	Annotation foreignAnn = null;
	HashSet<String> chrs = new HashSet<>();

	public Annotator() throws IOException, GFFException {
		gffp = new GFFPrinter(new PrintStream(Settings.S().getString(Settings.ANN_OUT)));
		gffp.printAnnotateHeader();
		in = SamReaderFactory.makeDefault().open(SamInputResource.of(new BufferedInputStream(new FileInputStream(Settings.S().getString(Settings.IN)),10000000)));
		iter = in.iterator();
		cur = iter.next();
		fasta = new IndexedFastaSequenceFile(new File(Settings.S().getString(Settings.FASTA)));
		if(!Settings.S().getString(Settings.ANN_FOREIGN).equals("-"))
			foreignAnn = new Annotation(Settings.S().getString(Settings.ANN_FOREIGN));		
	}
	
	public void annotate() throws IOException{
		do{
			chr_id = cur.getReferenceName();
			Log.println(chr_id);
			String seq =  new String(fasta.getSequence(chr_id).getBases());
			chrCov = new ChrCoverage(chr_id, seq);
			chrs.add(chr_id);
		}while(_annotate());
		
		// add genes from foreign annotation from chrs that do not have coverage
		if(foreignAnn != null){
			chrs = util.Util.diff(foreignAnn.getChrIDs(),chrs);
			for(String chr_id : chrs){
				String seq =  new String(fasta.getSequence(chr_id).getBases());
				chrCov = new ChrCoverage(chr_id, seq);
				chrCov.addForeighAnnotation(foreignAnn.getChrAnnotation(chr_id));
				ArrayList<Gene> genes = chrCov.findGenes();
				Collections.sort(genes);
				for(Gene g : genes)
					gffp.printGene(g);
			}
		}
		gffp.close();
		Log.printStat();
	}
	
	private boolean _annotate() throws FileNotFoundException{
		for(;;){
			Log.addStat(Log.TOTAL_READS, 1);
			chrCov.read(cur);
			cur = iter.next();
			if(cur == null || !cur.getReferenceName().equals(chr_id))
				break;
		}
		//first add annotation, then filter introns.
		if(foreignAnn != null)
			chrCov.addForeighAnnotation(foreignAnn.getChrAnnotation(chr_id));
		chrCov.filterIntrons();
		if(Settings.S().getBoolean(Settings.FILL_NS))
			chrCov.fillCovInNs();
		ArrayList<Gene> genes = chrCov.findGenes();
		for(Gene g : genes)
			gffp.printGene(g);
		return cur != null;
	}
	
}
